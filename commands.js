(()=>{var e={735(e){const t="https://06zyva2dth.execute-api.ap-northeast-1.amazonaws.com";e.exports&&(e.exports={createTicket:async function(e,o){const{subdomain:n,email:s,apiToken:i,groupId:a}=e,{subject:c,body:r,requesterEmail:l,requesterName:d,attachmentTokens:u}=o,m=`https://${n}/api/v2/tickets.json`,g={ticket:{subject:c,comment:{body:r,html_body:r,public:!1},requester:{email:l,name:d}}};a&&(g.ticket.group_id=parseInt(a,10)),u&&u.length>0&&(g.ticket.comment.uploads=u);const f=btoa(`${s}/token:${i}`);try{const e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${f}`},body:JSON.stringify(g)};let o=m;o=t,e.headers["X-Target-URL"]=m;const n=await fetch(o,e);if(!n.ok){const e=await n.text();throw new Error(`Zendesk API error (${n.status}): ${e}`)}return await n.json()}catch(e){throw console.error("Error creating Zendesk ticket:",e),e}},addCommentToTicket:async function(e,o,n){const{subdomain:s,email:i,apiToken:a}=e,{body:c,attachmentTokens:r}=n,l=`https://${s}/api/v2/tickets/${o}.json`,d={ticket:{comment:{body:c,html_body:c,public:!1}}};r&&r.length>0&&(d.ticket.comment.uploads=r);const u=btoa(`${i}/token:${a}`);try{const e={method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Basic ${u}`},body:JSON.stringify(d)};let o=l;o=t,e.headers["X-Target-URL"]=l;const n=await fetch(o,e);if(!n.ok){const e=await n.text();throw new Error(`Zendesk API error (${n.status}): ${e}`)}return await n.json()}catch(e){throw console.error("Error adding comment to Zendesk ticket:",e),e}},uploadAttachment:async function(e,o){const{subdomain:n,email:s,apiToken:i}=e,{filename:a,content:c}=o,r=`https://${n}/api/v2/uploads.json?filename=${encodeURIComponent(a)}`,l=btoa(`${s}/token:${i}`);try{let e;if("string"==typeof c){const t=atob(c),o=new Uint8Array(t.length);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e);e=o}else e=c;const o={method:"POST",headers:{Authorization:`Basic ${l}`,"Content-Type":"application/binary"},body:e};let n=r;n=t,o.headers["X-Target-URL"]=r;const s=await fetch(n,o);if(!s.ok){const e=await s.text();throw new Error(`Failed to upload attachment (${s.status}): ${e}`)}return(await s.json()).upload.token}catch(e){throw console.error("Error uploading attachment:",e),e}},testConnection:async function(e){const{subdomain:o,email:n,apiToken:s}=e,i=`https://${o}/api/v2/users/me.json`,a=btoa(`${n}/token:${s}`);try{const e={method:"GET",headers:{Authorization:`Basic ${a}`}};let o=i;return o=t,e.headers["X-Target-URL"]=i,(await fetch(o,e)).ok}catch(e){return console.error("Error testing Zendesk connection:",e),!1}},fetchGroups:async function(e){const{subdomain:o,email:n,apiToken:s}=e,i=`https://${o}/api/v2/groups.json`,a=btoa(`${n}/token:${s}`);try{const e={method:"GET",headers:{Authorization:`Basic ${a}`}};let o=i;o=t,e.headers["X-Target-URL"]=i;const n=await fetch(o,e);if(!n.ok)throw new Error(`Failed to fetch groups: ${n.status}`);return(await n.json()).groups||[]}catch(e){throw console.error("Error fetching Zendesk groups:",e),e}}})},869(e){const t="zendeskSubdomain",o="zendeskEmail",n="zendeskApiToken",s="ticketSubjectTemplate",i="addInEnabled",a="conversationTicketMap",c="zendeskGroupId";async function r(){return new Promise(e=>{e({subdomain:Office.context.roamingSettings.get(t)||"",email:Office.context.roamingSettings.get(o)||"",apiToken:Office.context.roamingSettings.get(n)||"",subjectTemplate:Office.context.roamingSettings.get(s)||"Support Request from Outlook",enabled:!1!==Office.context.roamingSettings.get(i),groupId:Office.context.roamingSettings.get(c)||""})})}e.exports&&(e.exports={saveSettings:async function(e){return new Promise((a,r)=>{Office.context.roamingSettings.set(t,e.subdomain||""),Office.context.roamingSettings.set(o,e.email||""),Office.context.roamingSettings.set(n,e.apiToken||""),Office.context.roamingSettings.set(s,e.subjectTemplate||"Support Request from Outlook"),Office.context.roamingSettings.set(i,!1!==e.enabled),Office.context.roamingSettings.set(c,e.groupId||""),Office.context.roamingSettings.saveAsync(e=>{e.status===Office.AsyncResultStatus.Succeeded?a():r(new Error("Failed to save settings: "+e.error.message))})})},loadSettings:r,isConfigured:async function(){const e=await r();return!!(e.subdomain&&e.email&&e.apiToken)},clearSettings:async function(){return new Promise((e,a)=>{Office.context.roamingSettings.remove(t),Office.context.roamingSettings.remove(o),Office.context.roamingSettings.remove(n),Office.context.roamingSettings.remove(s),Office.context.roamingSettings.remove(i),Office.context.roamingSettings.saveAsync(t=>{t.status===Office.AsyncResultStatus.Succeeded?e():a(new Error("Failed to clear settings: "+t.error.message))})})},saveConversationTicketMapping:async function(e,t){return new Promise((o,n)=>{const s=Office.context.roamingSettings.get(a)||{};s[e]=t,Office.context.roamingSettings.set(a,s),Office.context.roamingSettings.saveAsync(e=>{e.status===Office.AsyncResultStatus.Succeeded?o():n(new Error("Failed to save conversation mapping: "+e.error.message))})})},getTicketForConversation:async function(e){return new Promise(t=>{t((Office.context.roamingSettings.get(a)||{})[e]||null)})},clearConversationMappings:async function(){return new Promise((e,t)=>{Office.context.roamingSettings.remove(a),Office.context.roamingSettings.saveAsync(o=>{o.status===Office.AsyncResultStatus.Succeeded?e():t(new Error("Failed to clear mappings: "+o.error.message))})})}})}},t={};function o(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,o),i.exports}const n=o(869),s=o(735);async function i(e,t){return new Promise(o=>{e.subject.setAsync(t,e=>{e.status===Office.AsyncResultStatus.Succeeded||console.warn("Failed to set subject:",e.error),o()})})}async function a(e){return new Promise((t,o)=>{Office.context.mailbox.item.getAttachmentContentAsync(e,e=>{e.status!==Office.AsyncResultStatus.Failed?t(e.value.content):o(new Error("Failed to get attachment content: "+e.error.message))})})}function c(e,t){try{const o="zendesk-notification";Office.context.mailbox.item.notificationMessages.removeAsync(o,()=>{Office.context.mailbox.item.notificationMessages.addAsync(o,{type:"informationalMessage",message:`${e}: ${t}`,icon:"icon-16",persistent:!1})})}catch(e){console.error("Failed to show notification:",e)}}Office.onReady(()=>{}),Office.actions.associate("onMessageSend",async function(e){console.log("OnMessageSend event triggered");try{const t=await n.loadSettings();if(!t.enabled)return console.log("Add-in is disabled, allowing email to send without creating ticket"),void e.completed({allowEvent:!0});if(!await n.isConfigured())return console.log("Add-in not configured, allowing email to send"),c("Zendesk add-in not configured","Please configure the Zendesk add-in before sending emails."),void e.completed({allowEvent:!0});const o=Office.context.mailbox.item,r=await async function(e){return new Promise((t,o)=>{e.to.getAsync(n=>{if(n.status===Office.AsyncResultStatus.Failed)return void o(new Error("Failed to get recipients: "+n.error.message));const s=n.value;let i=Office.context.mailbox.userProfile.emailAddress,a=Office.context.mailbox.userProfile.displayName;s&&s.length>0&&(i=s[0].emailAddress,a=s[0].displayName||s[0].emailAddress),e.body.getAsync(Office.CoercionType.Html,n=>{if(n.status===Office.AsyncResultStatus.Failed)return void o(new Error("Failed to get email body: "+n.error.message));const s=n.value;e.getAttachmentsAsync(e=>{if(e.status===Office.AsyncResultStatus.Failed)return console.warn("Failed to get attachments:",e.error.message),void t({body:s,requesterEmail:i,requesterName:a,attachments:[]});const o=e.value||[];t({body:s,requesterEmail:i,requesterName:a,attachments:o})})})})})}(o);console.log("Ticket requester:",r.requesterEmail,r.requesterName);const l=o.conversationId,d=await async function(e){return new Promise(t=>{e.subject.getAsync(e=>{e.status===Office.AsyncResultStatus.Succeeded?t(e.value||"No Subject"):t("No Subject")})})}(o);console.log("Conversation ID:",l),console.log("Email Subject:",d);const u=function(e){const t=[/\[#(\d+)\]/,/\[Ticket #(\d+)\]/i,/\[ZD#(\d+)\]/i];for(const o of t){const t=e.match(o);if(t&&t[1])return parseInt(t[1])}return null}(d);console.log("Ticket ID from subject:",u);let m=null;u?(m=u,console.log("Using ticket from subject line:",m)):l&&""!==l.trim()?(m=await n.getTicketForConversation(l),console.log("Existing ticket for conversation:",m)):console.log("No ticket ID found - this is a new email, will create new ticket");const g=await async function(e,t){const o=[];for(const n of t)try{const t=await a(n.id),i=await s.uploadAttachment(e,{filename:n.name,content:t});o.push(i),console.log(`Uploaded attachment: ${n.name}`)}catch(e){console.error(`Failed to upload attachment ${n.name}:`,e)}return o}(t,r.attachments);if(m){console.log("Updating existing ticket:",m);const e={body:r.body,attachmentTokens:g};if(await s.addCommentToTicket(t,m,e),console.log("Comment added to ticket:",m),!u){const e=`${d} [#${m}]`;await i(o,e),console.log("Added ticket ID to reply subject:",e)}l&&""!==l.trim()&&await n.saveConversationTicketMapping(l,m),c("Zendesk Ticket Updated",`Ticket #${m} has been updated with your message.`)}else{console.log("Creating new ticket for conversation:",l);const e={subject:t.subjectTemplate,body:r.body,requesterEmail:r.requesterEmail,requesterName:r.requesterName,attachmentTokens:g},a=(await s.createTicket(t,e)).ticket.id;if(console.log("Zendesk ticket created successfully:",a),!u){const e=`${d} [#${a}]`;await i(o,e),console.log("Added ticket ID to subject:",e)}l&&""!==l.trim()&&(await n.saveConversationTicketMapping(l,a),console.log("Saved ticket mapping with conversationId")),c("Zendesk Ticket Created",`Ticket #${a} has been created successfully.`)}e.completed({allowEvent:!0})}catch(t){console.error("Error creating Zendesk ticket:",t),c("Zendesk Error","Failed to create ticket: "+t.message),e.completed({allowEvent:!0})}}),Office.actions.associate("toggleZendesk",async function(e){console.log("Toggle Zendesk button clicked");try{const t=await n.loadSettings();t.enabled=!t.enabled,await n.saveSettings(t),console.log("Zendesk integration toggled to:",t.enabled);const o=t.enabled?"Enabled":"Disabled",s=`zendesk-toggle-${Date.now()}`;console.log("Attempting to show notification..."),Office.context.mailbox.item.notificationMessages.addAsync(s,{type:"informationalMessage",message:`Zendesk ${o}: Ticket creation is now ${o.toLowerCase()}`,icon:"icon-16",persistent:!1},e=>{e.status===Office.AsyncResultStatus.Failed?console.error("Failed to show notification:",e.error):console.log("Notification shown successfully!")}),e.completed()}catch(t){console.error("Error toggling Zendesk:",t),Office.context.mailbox.item.notificationMessages.addAsync(`zendesk-error-${Date.now()}`,{type:"errorMessage",message:"Failed to toggle Zendesk: "+t.message}),e.completed()}})})();
//# sourceMappingURL=commands.js.map