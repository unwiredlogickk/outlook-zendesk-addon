const storage=require("../utils/storage"),zendesk=require("../services/zendesk");async function onMessageSend(e){console.log("OnMessageSend event triggered");try{const t=await storage.loadSettings();if(!t.enabled)return console.log("Add-in is disabled, allowing email to send without creating ticket"),void e.completed({allowEvent:!0});if(!await storage.isConfigured())return console.log("Add-in not configured, allowing email to send"),showNotification("Zendesk add-in not configured","Please configure the Zendesk add-in before sending emails."),void e.completed({allowEvent:!0});const o=Office.context.mailbox.item,n=await extractEmailData(o);console.log("Ticket requester:",n.requesterEmail,n.requesterName);const s=o.conversationId,a=await getEmailSubject(o);console.log("Conversation ID:",s),console.log("Email Subject:",a);const i=extractTicketIdFromSubject(a);console.log("Ticket ID from subject:",i);let c=null;i?(c=i,console.log("Using ticket from subject line:",c)):s&&""!==s.trim()?(c=await storage.getTicketForConversation(s),console.log("Existing ticket for conversation:",c)):console.log("No ticket ID found - this is a new email, will create new ticket");const r=await uploadAttachments(t,n.attachments);if(c){console.log("Updating existing ticket:",c);const e={body:n.body,attachmentTokens:r};if(await zendesk.addCommentToTicket(t,c,e),console.log("Comment added to ticket:",c),!i){const e=`${a} [#${c}]`;await setEmailSubject(o,e),console.log("Added ticket ID to reply subject:",e)}s&&""!==s.trim()&&await storage.saveConversationTicketMapping(s,c),showNotification("Zendesk Ticket Updated",`Ticket #${c} has been updated with your message.`)}else{console.log("Creating new ticket for conversation:",s);const e={subject:t.subjectTemplate,body:n.body,requesterEmail:n.requesterEmail,requesterName:n.requesterName,attachmentTokens:r},c=(await zendesk.createTicket(t,e)).ticket.id;if(console.log("Zendesk ticket created successfully:",c),!i){const e=`${a} [#${c}]`;await setEmailSubject(o,e),console.log("Added ticket ID to subject:",e)}s&&""!==s.trim()&&(await storage.saveConversationTicketMapping(s,c),console.log("Saved ticket mapping with conversationId")),showNotification("Zendesk Ticket Created",`Ticket #${c} has been created successfully.`)}e.completed({allowEvent:!0})}catch(t){console.error("Error creating Zendesk ticket:",t),showNotification("Zendesk Error","Failed to create ticket: "+t.message),e.completed({allowEvent:!0})}}async function getEmailSubject(e){return new Promise(t=>{e.subject.getAsync(e=>{e.status===Office.AsyncResultStatus.Succeeded?t(e.value||"No Subject"):t("No Subject")})})}async function setEmailSubject(e,t){return new Promise(o=>{e.subject.setAsync(t,e=>{e.status===Office.AsyncResultStatus.Succeeded||console.warn("Failed to set subject:",e.error),o()})})}function extractTicketIdFromSubject(e){const t=[/\[#(\d+)\]/,/\[Ticket #(\d+)\]/i,/\[ZD#(\d+)\]/i];for(const o of t){const t=e.match(o);if(t&&t[1])return parseInt(t[1])}return null}async function extractEmailData(e){return new Promise((t,o)=>{e.to.getAsync(n=>{if(n.status===Office.AsyncResultStatus.Failed)return void o(new Error("Failed to get recipients: "+n.error.message));const s=n.value;let a=Office.context.mailbox.userProfile.emailAddress,i=Office.context.mailbox.userProfile.displayName;s&&s.length>0&&(a=s[0].emailAddress,i=s[0].displayName||s[0].emailAddress),e.body.getAsync(Office.CoercionType.Html,n=>{if(n.status===Office.AsyncResultStatus.Failed)return void o(new Error("Failed to get email body: "+n.error.message));const s=n.value;e.getAttachmentsAsync(e=>{if(e.status===Office.AsyncResultStatus.Failed)return console.warn("Failed to get attachments:",e.error.message),void t({body:s,requesterEmail:a,requesterName:i,attachments:[]});const o=e.value||[];t({body:s,requesterEmail:a,requesterName:i,attachments:o})})})})})}async function uploadAttachments(e,t){const o=[];for(const n of t)try{const t=await getAttachmentContent(n.id),s=await zendesk.uploadAttachment(e,{filename:n.name,content:t});o.push(s),console.log(`Uploaded attachment: ${n.name}`)}catch(e){console.error(`Failed to upload attachment ${n.name}:`,e)}return o}async function getAttachmentContent(e){return new Promise((t,o)=>{Office.context.mailbox.item.getAttachmentContentAsync(e,e=>{e.status!==Office.AsyncResultStatus.Failed?t(e.value.content):o(new Error("Failed to get attachment content: "+e.error.message))})})}function showNotification(e,t){try{const o="zendesk-notification";Office.context.mailbox.item.notificationMessages.removeAsync(o,()=>{Office.context.mailbox.item.notificationMessages.addAsync(o,{type:"informationalMessage",message:`${e}: ${t}`,icon:"icon-16",persistent:!1})})}catch(e){console.error("Failed to show notification:",e)}}async function toggleZendesk(e){console.log("Toggle Zendesk button clicked");try{const t=await storage.loadSettings();t.enabled=!t.enabled,await storage.saveSettings(t),console.log("Zendesk integration toggled to:",t.enabled);const o=t.enabled?"Enabled":"Disabled",n=`zendesk-toggle-${Date.now()}`;console.log("Attempting to show notification..."),Office.context.mailbox.item.notificationMessages.addAsync(n,{type:"informationalMessage",message:`Zendesk ${o}: Ticket creation is now ${o.toLowerCase()}`,icon:"icon-16",persistent:!1},e=>{e.status===Office.AsyncResultStatus.Failed?console.error("Failed to show notification:",e.error):console.log("Notification shown successfully!")}),e.completed()}catch(t){console.error("Error toggling Zendesk:",t),Office.context.mailbox.item.notificationMessages.addAsync(`zendesk-error-${Date.now()}`,{type:"errorMessage",message:"Failed to toggle Zendesk: "+t.message}),e.completed()}}Office.onReady(()=>{}),Office.actions.associate("onMessageSend",onMessageSend),Office.actions.associate("toggleZendesk",toggleZendesk);