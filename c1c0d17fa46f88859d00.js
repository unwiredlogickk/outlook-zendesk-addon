const storage=require("../utils/storage"),zendesk=require("../services/zendesk");async function loadConfiguration(){try{const e=await storage.loadSettings();if(document.getElementById("subdomain").value=e.subdomain||"",document.getElementById("email").value=e.email||"",document.getElementById("apiToken").value=e.apiToken||"",document.getElementById("subjectTemplate").value=e.subjectTemplate||"Support Request from Outlook",document.getElementById("enabled").checked=!1!==e.enabled,e.groupId){const t=document.getElementById("groupId");let o=!1;for(let n=0;n<t.options.length;n++)if(t.options[n].value===e.groupId){o=!0;break}if(!o){const o=document.createElement("option");o.value=e.groupId,o.textContent=`Group ID: ${e.groupId}`,t.appendChild(o)}t.value=e.groupId}e.subdomain&&e.email&&e.apiToken&&showStatus("Configuration loaded successfully","success")}catch(e){console.error("Error loading configuration:",e),showStatus("Error loading configuration: "+e.message,"error")}}async function saveConfiguration(){const e=document.getElementById("saveButton"),t=e.textContent;try{e.disabled=!0,e.textContent="Saving...";const t=document.getElementById("subdomain").value.trim(),o=document.getElementById("email").value.trim(),n=document.getElementById("apiToken").value.trim(),s=document.getElementById("subjectTemplate").value.trim()||"Support Request from Outlook",a=document.getElementById("enabled").checked,i=document.getElementById("groupId").value.trim();if(!t||!o||!n)return void showStatus("Please fill in all required fields","error");if(!t.includes(".zendesk.com"))return void showStatus("Subdomain should be in format: yourcompany.zendesk.com","error");await storage.saveSettings({subdomain:t,email:o,apiToken:n,subjectTemplate:s,enabled:a,groupId:i}),showStatus("Configuration saved successfully!","success")}catch(e){console.error("Error saving configuration:",e),showStatus("Error saving configuration: "+e.message,"error")}finally{e.disabled=!1,e.textContent=t}}async function testConnection(){const e=document.getElementById("testButton"),t=e.textContent;try{e.disabled=!0,e.textContent="Testing...";const t=document.getElementById("subdomain").value.trim(),o=document.getElementById("email").value.trim(),n=document.getElementById("apiToken").value.trim();if(!t||!o||!n)return void showStatus("Please fill in all fields before testing","error");if(!t.includes(".zendesk.com"))return void showStatus("Subdomain should be in format: yourcompany.zendesk.com","error");await zendesk.testConnection({subdomain:t,email:o,apiToken:n})?(showStatus("Connection successful! Your credentials are valid.","success"),setTimeout(()=>{loadGroups()},500)):showStatus("Connection failed. Please check your credentials.","error")}catch(e){console.error("Error testing connection:",e),showStatus("Connection test failed: "+e.message,"error")}finally{e.disabled=!1,e.textContent=t}}async function clearMappings(){const e=document.getElementById("clearMappingsButton"),t=e.textContent;try{e.disabled=!0,e.textContent="Clearing...",await storage.clearConversationMappings(),showStatus("Thread mappings cleared successfully! New emails will create new tickets.","success")}catch(e){console.error("Error clearing mappings:",e),showStatus("Error clearing mappings: "+e.message,"error")}finally{e.disabled=!1,e.textContent=t}}async function loadGroups(){const e=document.getElementById("loadGroupsButton"),t=e.textContent,o=document.getElementById("groupId");try{e.disabled=!0,e.textContent="Loading...",o.disabled=!0;const t=document.getElementById("subdomain").value.trim(),n=document.getElementById("email").value.trim(),s=document.getElementById("apiToken").value.trim();if(!t||!n||!s)return void showStatus("Please fill in credentials before loading groups","error");const a=await zendesk.fetchGroups({subdomain:t,email:n,apiToken:s});o.innerHTML='<option value="">-- No Group Assignment --</option>',0===a.length?showStatus("No groups found in your Zendesk account","info"):(a.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,o.appendChild(t)}),showStatus(`Loaded ${a.length} group(s) successfully!`,"success"))}catch(e){console.error("Error loading groups:",e),showStatus("Failed to load groups: "+e.message,"error")}finally{e.disabled=!1,e.textContent=t,o.disabled=!1}}function showStatus(e,t){const o=document.getElementById("statusMessage");o.textContent=e,o.className=`status-message ${t}`,o.classList.remove("hidden"),setTimeout(()=>{o.classList.add("hidden")},5e3)}Office.onReady(e=>{e.host===Office.HostType.Outlook&&(document.getElementById("saveButton").onclick=saveConfiguration,document.getElementById("testButton").onclick=testConnection,document.getElementById("clearMappingsButton").onclick=clearMappings,document.getElementById("loadGroupsButton").onclick=loadGroups,loadConfiguration())});